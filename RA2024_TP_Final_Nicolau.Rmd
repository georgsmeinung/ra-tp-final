---
title: "Regresión Avanzada 2024"
subtitle: "Trabajo Práctico Final"
author: "Jorge Nicolau"
output:
   html_document:
     toc: yes
     code_folding: show
     toc_float: yes
     df_print: paged
     theme: united
     code_download: true
editor_options: 
  markdown: 
    wrap: none
---

```{r setup, include=FALSE}
# Limpieza del Workspace
rm(list = ls())

# Determinar el directorio del script actual
# y cambiar el working directory al directorio del script actual
library(rstudioapi)
script_full_path <- rstudioapi::getSourceEditorContext()$path
script_path <- file.path(dirname(script_full_path), "")
setwd(script_path)

knitr::opts_chunk$set(echo = TRUE)
# Deshabilita la impresión de tus resultados en notación científica
options(scipen=999)
```

# Preprocesamiento de Datos

El dataset de exoplanetas detectados por la misión Kepler contiene información sobre 28.217 exoplanetas (entre confirmados y propuetos) y sus características. El objetivo de este trabajo es preprocesar los datos para realizar un análisis exploratorio y utilizar regresión linea y logística para la extracción de paramétros faltantes de los exoplanetas y para predecir la habitabilidad de los mismos.

Se cargarán los datos, se filtrarán las filas de los explonetas confirmados, las columnas relevantes, se eliminarán los valores faltantes y se realizará un análisis exploratorio de los datos.

## Carga de Datos

Se cargan los datos del dataset de exoplanetas de la misión Kepler del archivo `keplerexoplanets.csv`. El mismo se obtuvo de la página del IPAC del Caltech (https://exoplanetarchive.ipac.caltech.edu/cgi-bin/TblView/nph-tblView?app=ExoTbls&config=PS) y contiene información sobre los sistemas exoplanetaarios detectados por la misión Kepler (https://science.nasa.gov/mission/kepler/).

```{r load_data}
library(readr)

# Cargar los datos
kepler_data <- read_csv("keplerexoplanets.csv")

# Mostrar la estructura de los datos sin truncar
str(kepler_data, list.len = Inf)
```

Se filtra por la columan `soltype` para obtener solo los registros de exoplanetas confirmados, o valor "Published Confirmed", además se eliman las columnas con referencias a sitios web no relevantes para el análisis. También se eliminan los datos de referencia de los planetas, estrellas y sistemas no relevantes para el análisis.

```{r filter_data}

library(dplyr)
# Filtrar los datos por soltype = "Published Confirmed"
kepler_data <- kepler_data %>%
  filter(soltype == "Published Confirmed")

# Eliminar también soltype
kepler_data <- kepler_data %>%
  select(-soltype)

# Eliminar columnas de referencias a sitios web
kepler_data <- kepler_data %>%
  select(-disc_refname, -pl_refname, -st_refname, -sy_refname)

# Eliminar columnas de id de estrellas y sistemas
kepler_data <- kepler_data %>%
  select(-tic_id, -gaia_id, hostname, hd_name, hip_name)

# Eliminar información referente a la publicación del descubrimiento
# así como la información del instrumento utilizado, para todos es Kepler
kepler_data <- kepler_data %>%
  select(-disc_year, -disc_pubdate, -disc_locale, -disc_facility, -disc_telescope, -disc_instrument, -rowupdate, -pl_pubdate, -releasedate)

# Eliminar columnas con información referente a la detección
kepler_data <- kepler_data %>%
  select(-rv_flag, -pul_flag, -ptv_flag, -tran_flag, -ast_flag, -obm_flag, -micro_flag, -etv_flag, -ima_flag, dkin_flag)

# Eliminar columnas con información de fotometria
kepler_data <- kepler_data %>%
  select(-sy_bmag, -sy_vmag, -sy_jmag, -sy_hmag, -sy_kmag, -sy_umag, -sy_gmag, -sy_rmag, -sy_imag, -sy_zmag, -sy_w1mag, -sy_w2mag, -sy_w3mag, -sy_w4mag, -sy_gaiamag, -sy_icmag, -sy_tmag, -sy_kepmag)

# Mostrar la estructura de los datos filtrados sin truncar
str(kepler_data, list.len = Inf)
```
El dataset resultante se guarda en un archivo CSV llamado `keplerfiltered.csv`. El dataset resultante contiene 10.895 registros y 105 columnas.

```{r save_filtered_dataset, eval = FALSE}
# Guardar los datos filtrados
write_csv(kepler_data, "keplerfiltered.csv")
```

# Análisis Exploratorio de Datos

Para realizar un análisis exploratorio de los datos, se cargan el nuevo dataset y se realizan algunas visualizaciones y cálculos descriptivos.

```{r eda_filtered_data}

library(ggplot2)
library(dplyr)
library(readr)
library(skimr)
library(knitr)

# Leer los datos completos
kepler_data <- read_csv("keplerfiltered.csv")

# Resumen de los datos con skimr solo variables numéricas
kepler_data_num <- kepler_data %>%
  select_if(is.numeric)

# Generar resumen con skimr 
resumen <- skim(kepler_data_num) 

# Filtrar columnas relevantes
resumen <- resumen %>%
  select(skim_variable, numeric.mean, numeric.sd, numeric.p0, numeric.p25, 
         numeric.p50, numeric.p75, numeric.p100)

# Mostrar tabla formateada
kable(resumen, format = "markdown")

```

## Detención de Valores Faltantes

Se analiza la cantidad de valores faltantes en el dataset para identificar posibles problemas de calidad de datos.

```{r missing_values, warning=FALSE, message=FALSE}
library(tidyr)

# Calcular la cantidad de valores faltantes por columna
missing_values <- kepler_data %>%
  summarise_all(~sum(is.na(.))) %>%
  gather() %>%
  arrange(desc(value))

# Eliminar las columnas sin valores faltantes
missing_values <- missing_values %>%
  filter(value > 0)

# Crear un gráfico de barras con los valores faltantes que no sean cero
ggplot(missing_values, aes(x = reorder(key, value), y = value)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "darkblue", width = 0.5) + # Reducir ancho de las barras
  coord_flip() +
  labs(title = "Valores Faltantes por Columna",
       x = "Columna",
       y = "Cantidad de Valores Faltantes") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 5),   # Ajustar tamaño de texto en eje Y
    plot.title = element_text(hjust = 0.5)  # Centrar el título
  )

```
Se detectan grandes cantidades valores faltantes en varias columnas del dataset, probablemente debido a la falta de estimaciones o mediciones para esos exoplanetas. Según los prefijos de columnas explicados en el detalle del dataset (https://exoplanetarchive.ipac.caltech.edu/docs/API_PS_columns.html#planetparam), se pueden identificar las siguientes categorías de variables:

- `pl_`: Parámetros del planeta.
- `st_`: Parámetros de la estrella.
- `sy_`: Parámetros del sistema.

Buena parte de las variables faltantes corresponden a parámetros de los exoplanetas y sistemas, lo que puede dificultar el análisis y la predicción de la habitabilidad de los exoplanetas.

El propósito de este trabajo es estimar los valores faltantes de los exoplanetas y predecir la habitabilidad de los mismos. Para ello, se utilizarán técnicas de regresión lineal y logística para estimar los valores faltantes y predecir la habitabilidad de los exoplanetas.

## Buscando Correlaciones

Se analiza la correlación entre las variables numéricas del dataset para identificar posibles relaciones entre ellas.

Por ser un dataset con muchas variables, se utiliza una matriz de correlación para visualizar las relaciones entre las variables numéricas. En primer lugar sólo para las variables numéricas de datos de demograficos (transacciones y georreferencias) y luego para datos financieros de usuarios (transacciones y usuarios)

```{r plot_correlation_st_upper_quadrant}

library(corrplot)

# Calcular la matriz de correlación
correlation_matrix_st <- cor(kepler_data_num, use = "pairwise.complete.obs")

# Número de variables
n_vars <- ncol(correlation_matrix_st)
half <- ceiling(n_vars / 2)

# Parte 1: Primera mitad (diagonal superior)
correlation_matrix_part1 <- correlation_matrix_st[1:half, 1:half]
corrplot(
  correlation_matrix_part1,
  method = "color",
  type = "upper",
  addCoef.col = "black",
  number.cex = 0.5,
  tl.cex = 0.7,
  tl.col = "black",
  col = colorRampPalette(c("salmon", "white", "skyblue"))(10),
  title = "Matriz de Correlación"
)

```

```{r plot_correlation_st_cross}

# Parte 3: Cruce entre la primera y segunda mitad
correlation_matrix_cross <- correlation_matrix_st[1:half, (half + 1):n_vars]
corrplot(
  correlation_matrix_cross,
  method = "color",
  type = "full",  # Mostrar todas las correlaciones en esta sección
  addCoef.col = "black",
  number.cex = 0.5,
  tl.cex = 0.7,
  tl.col = "black",
  col = colorRampPalette(c("salmon", "white", "skyblue"))(10),
  title = "Matriz de Correlación - Parte 3 (Cruce)"
)

```


```{r plot_correlation_st_lower_quadrant}

# Parte 2: Segunda mitad (diagonal superior)
correlation_matrix_part2 <- correlation_matrix_st[(half + 1):n_vars, (half + 1):n_vars]
corrplot(
  correlation_matrix_part2,
  method = "color",
  type = "upper",
  addCoef.col = "black",
  number.cex = 0.5,
  tl.cex = 0.7,
  tl.col = "black",
  col = colorRampPalette(c("salmon", "white", "skyblue"))(10),
  title = "Matriz de Correlación - Parte 2 (Cuadrante inferior)"
)

```


Parece haber poca correlación entre las variables numéricas de los datos demograficos y los de las transacciones financieras. Esto puede indicar 
- Efectivamente las variables demográficas y financieras son independientes entre sí.
- La falta de correlación puede deberse a la falta de información verdadera: se sabe que los datos de las transacciones son sintéticos y no se puede no reflejar hábitos que si se podrían deducir a partir de las variables demográficas. Esto es, los datos demográficos son reales y no se pueden correlacionar con datos ficticios.

```{r plot_correlation_ud}  
library(dplyr)

# Seleccionar las columnas numéricas de los datos de transacciones y los que 
# comienzan con ud_ además de las 7 primeras columnas del dataset 
# sin prefijo (las de originales)

demo_data_ud <- transactions_data %>%
  select(1:7, starts_with("ud_"))

# filtrar solo las columnas numéricas
demo_data_ud <- demo_data_ud %>%
  select_if(is.numeric)

# Calcular la matriz de correlación
correlation_matrix_ud <- cor(demo_data_ud, use = "pairwise.complete.obs")

corrplot(
  correlation_matrix_ud,
  method = "color",
  type = "upper",
  addCoef.col = "black",
  number.cex = 0.5,
  tl.cex = 0.7,
  tl.col = "black",
  col = colorRampPalette(c("salmon", "white", "skyblue"))(200),
  title = "Matriz de Correlación - Parte 1 (Cuadrante Superior)"
)
```

Pueden observarse correlaciones entre las variables financieras de los usuarios, lo que podría indicar relaciones entre ellas. Por ejemplo, la deuda total y el ingreso per cápita podrían estar correlacionados, lo que podría indicar que los usuarios con mayores ingresos tienen una deuda total más alta. También se observa una correlación negativa entre la edad y el número de tarjetas, lo que podría indicar que los usuarios más jóvenes tienen más tarjetas.  

# Analisis de Regresión

Para analizar la relación entre las variables financieras de los usuarios y las transacciones, se realiza un análisis de regresión lineal. Se seleccionan las variables financieras de los usuarios como variables independientes.

## Regresión Lineal Univariada

Las variables financieras de los usuarios seleccionadas son:
- `ud_per_capita_income`: Ingreso per cápita del usuario.
- `ud_total_debt`: Deuda total del usuario.
- `cd_credit_limit`: Límite de crédito de la tarjeta del usuario.

Con estas variables se intenta predecir el monto de la transacción (`amount`). Primeramente se intenta predecir el monto de la transacción a partir cada una de las variables financieras de los usuarios (modelos univariados) y luego se intenta predecir el monto de la transacción a partir de la commbinación de todas las variables financieras de los usuarios (modelo multivariado).

```{r linear_regression_univariate_income}

# Seleccionar las variables financieras de los usuarios y
# el monto de la transacción
# Modelo 1: Ingreso per cápita del usuario vs Monto de la transacción

model_income <- lm(amount ~ ud_per_capita_income, data = transactions_data)

summary(model_income)

```


```{r linear_regression_univariate_income_plot}  
# Diagrama de dispersión
# con recta de regresión en color rojo
ggplot(transactions_data, aes(x = ud_per_capita_income, y = amount)) +
  geom_point(color = "darkgrey", alpha = 0.6, size = 2) +  # Puntos con transparencia y tamaño ajustado
  geom_smooth(
    method = "lm", 
    color = "red", 
    fill = "lightpink",    # Color de la banda del intervalo de confianza
    alpha = 0.3,           # Transparencia de la banda
    se = TRUE              # Mostrar intervalo de confianza
  ) +
  labs(
    title = "Ingreso Per Cápita vs Monto de la Transacción",
    x = "Ingreso Per Cápita",
    y = "Monto de la Transacción"
  ) +
  theme_minimal(base_size = 14) +  # Tema minimalista con texto más legible
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Título centrado y en negrita
    axis.title = element_text(size = 14),                             # Tamaño de etiquetas de ejes
    axis.text = element_text(size = 12)                              # Tamaño de texto en los ejes
  )

```


```{r linear_regression_univariate_debt}

# Modelo 2: Deuda total del usuario vs Monto de la transacción
model_debt <- lm(amount ~ ud_total_debt, data = transactions_data)

summary(model_debt)

```


```{r linear_regression_univariate_debt_plot}
# Diagrama de dispersión
# con recta de regresión en color rojo
ggplot(transactions_data, aes(x = ud_total_debt, y = amount)) +
  geom_point(
    color = "darkgrey",       # Cambiar el color de los puntos para mayor contraste
    alpha = 0.6,              # Añadir transparencia para evitar saturación visual
    size = 3                  # Ajustar el tamaño de los puntos
  ) +
  geom_smooth(
    method = "lm",
    color = "red",            # Color de la recta de regresión
    fill = "pink",            # Color de la banda del intervalo de confianza
    alpha = 0.3,              # Transparencia de la banda
    se = TRUE                 # Mostrar intervalo de confianza
  ) +
  labs(
    title = "Deuda Total vs Monto de la Transacción",
    x = "Deuda Total",
    y = "Monto de la Transacción"
  ) +
  theme_minimal(base_size = 15) +  # Tamaño base más grande para mejor legibilidad
  theme(
    plot.title = element_text(
      hjust = 0.5,            # Centrar el título
      size = 18,              # Tamaño más grande para el título
      face = "bold"           # Negrita en el título
    ),
    axis.title = element_text(size = 14),  # Tamaño de etiquetas de los ejes
    axis.text = element_text(size = 12)    # Tamaño del texto de los ejes
  )

```


```{r linear_regression_univariate_credit_limit}

# Modelo 3: Límite de crédito del usuario
# vs Monto de la transacción
model_credit_limit <- lm(amount ~ cd_credit_limit, data = transactions_data)

summary(model_credit_limit)

```

```{r linear_regression_univariate_credit_limit_plot}

# Diagrama de dispersión
# con recta de regresión en color rojo
ggplot(transactions_data, aes(x = cd_credit_limit, y = amount)) +
  geom_point(
    color = "darkgrey",       # Cambiar el color de los puntos para mayor contraste
    alpha = 0.6,              # Añadir transparencia para evitar saturación visual
    size = 3                  # Ajustar el tamaño de los puntos
  ) +
  geom_smooth(
    method = "lm",
    color = "red",            # Color de la recta de regresión
    fill = "pink",            # Color de la banda del intervalo de confianza
    alpha = 0.3,              # Transparencia de la banda
    se = TRUE                 # Mostrar intervalo de confianza
  ) +
  labs(
    title = "Límite de Crédito vs Monto de la Transacción",
    x = "Límite de Crédito",
    y = "Monto de la Transacción"
  ) +
  theme_minimal(base_size = 15) +  # Tamaño base más grande para mejor legibilidad
  theme(
    plot.title = element_text(
      hjust = 0.5,            # Centrar el título
      size = 18,              # Tamaño más grande para el título
      face = "bold"           # Negrita en el título
    ),
    axis.title = element_text(size = 14),  # Tamaño de etiquetas de los ejes
    axis.text = element_text(size = 12)    # Tamaño del texto de los ejes
  )

```

## Regresión Lineal Multivariada

Se realiza un análisis de regresión lineal multivariada para predecir el monto de la transacción a partir de variables financieras seleccionadas de los usuarios:

- `ud_per_capita_income`: Ingreso per cápita del usuario.
- `ud_total_debt`: Deuda total del usuario.
- `cd_credit_limit`: Límite de crédito de la tarjeta del usuario.

Se intenta provar si estas variables financieras conbinadas pueden predecir mejor el monto de la transacción que las variables financieras por separado.

```{r linear_regression_multivariate}

# Modelo multivariado
model_multivariate <- lm(amount ~ ud_per_capita_income + ud_total_debt + cd_credit_limit, data = transactions_data)

summary(model_multivariate)

```
Los valores residuales (errores entre los valores observados y los predichos) tienen un rango amplio (desde -569.05 hasta 2921.88) lo que sugiere cierta variabilidad no explicada por el modelo.

Asimismo los coeficientes para los predictores muestran que:
- `ud_per_capita_income` (0.0006720): Un aumento de 1 unidad en el ingreso per cápita se asocia con un aumento promedio de 0.000672 en amount, manteniendo constantes las otras variables. Es altamente significativo (p<0.001).
- `ud_total_debt` (-0.000008233): Un aumento de 1 unidad en la deuda total se asocia con una disminución promedio de 0.000008233 en amount. Sin embargo, su significancia estadística es baja (p=0.081), por lo que su efecto puede no ser confiable.
- `cd_credit_limit` (0.0000781): Un aumento de 1 unidad en el límite de crédito se asocia con un aumento promedio de 0.0000781 en amount. Este coeficiente es significativo (p=0.00072).

Para validar el modelo de regresión lineal multivariada, se analiza la distribución de los residuos (errores entre los valores observados y los predichos) y se calcula el coeficiente de determinación (R²) para evaluar la bondad del ajuste del modelo.

- R-cuadrado múltiple (0.01075): El modelo explica solo el 1.075% de la variabilidad total en amount, esto es el modelo tiene un ajuste muy bajo.
- R-cuadrado ajustado (0.01073): Similar al R-cuadrado, pero ajustado por el número de predictores. Confirma un bajo poder explicativo.
- F-statistic (481.8, p < 0.00000000000000022): Prueba global de si al menos uno de los predictores tiene un efecto significativo. Aunque el p-valor es extremadamente bajo, el impacto práctico de los predictores parece limitado debido al bajo R².

El R-cuadrado mide qué proporción de la variabilidad total de la variable dependiente (en este caso, `amount`) es explicada por las variables independientes del modelo (`ud_per_capita_income`, `ud_total_debt`, `cd_credit_limit`).

En este modelo, el R-cuadrado múltiple es de 0.01075, lo que significa que solo el 1.075% de la variabilidad en `amount` puede ser explicada por las variables financieras de los usuarios incluidas en el modelo. Por lo tanto, el 98.925% restante de la variabilidad en `amount` se debe a otros factores que no están incluidos en este modelo.
